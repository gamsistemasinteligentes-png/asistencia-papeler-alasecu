<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia - Papeler√≠a La Secu</title>
    <style>
        :root { --primary: #0056b3; --accent: #25D366; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; padding: 2.5rem 1.5rem; border-radius: 24px; box-shadow: 0 15px 40px rgba(0,0,0,0.12); width: 90%; max-width: 380px; text-align: center; border-top: 10px solid var(--primary); }
        h1 { color: var(--primary); font-size: 1.6rem; margin-bottom: 5px; letter-spacing: -0.5px; }
        .subtitle { color: #777; font-size: 0.9rem; margin-bottom: 25px; }
        
        select { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #eee; font-size: 1rem; background: #fff; margin-bottom: 15px; outline: none; transition: 0.3s; }
        select:focus { border-color: var(--primary); }
        
        button { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: bold; color: white; background: var(--accent); cursor: pointer; transition: 0.3s; box-shadow: 0 6px 15px rgba(37, 211, 102, 0.3); }
        button:disabled { background: #cbd5e0; box-shadow: none; cursor: not-allowed; transform: none; }
        button:active { transform: scale(0.98); }

        #status { margin-top: 20px; font-weight: 700; font-size: 0.95rem; padding: 12px; border-radius: 10px; background: #fdfdfd; border: 1px solid #eee; transition: 0.5s; }
        
        .history { margin-top: 25px; text-align: left; border-top: 1px solid #eee; padding-top: 15px; }
        .history h3 { font-size: 0.75rem; color: #aaa; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }
        .log-item { font-size: 0.8rem; color: #555; padding: 8px; border-bottom: 1px dotted #eee; background: #fafafa; margin-bottom: 4px; border-left: 4px solid var(--primary); border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h1>Papeler√≠a La Secu</h1>
    <div class="subtitle">Control de Asistencia Satelital</div>
    
    <select id="employee">
        <option value="">-- Selecciona tu nombre --</option>
        <option value="Empleado 1">Empleado 1</option>
        <option value="Empleado 2">Empleado 2</option>
        <option value="Empleado 3">Empleado 3</option>
        <option value="Empleado 4">Empleado 4</option>
        <option value="Empleado 5">Empleado 5</option>
    </select>

    <button id="btnReg" onclick="registrar()" disabled>REGISTRAR ASISTENCIA</button>
    
    <div id="status">‚è≥ Iniciando GPS...</div>

    <div class="history">
        <h3>Tus √∫ltimos registros (Local)</h3>
        <div id="logBox"></div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN REAL DEL NEGOCIO
    const CONFIG = {
        lat: 18.906744582104004,
        lon: -103.86840310462902,
        rango: 60, // Metros de tolerancia (Ideal para GPS de celular)
        tel: "523339019091" // N√∫mero del patr√≥n con c√≥digo de pa√≠s
    };

    let userCoords = null;

    function init() {
        const status = document.getElementById('status');
        if (!navigator.geolocation) {
            status.innerHTML = "‚ùå GPS no compatible";
            return;
        }

        // Configuramos opciones para una respuesta m√°s r√°pida
        const geoOptions = {
            enableHighAccuracy: true, // Cambia a false si sigue tardando en conectar
            timeout: 10000,
            maximumAge: 0
        };

        status.innerHTML = "üõ∞Ô∏è Buscando se√±al...";

        // Vigilancia constante de la ubicaci√≥n
        navigator.geolocation.watchPosition(updatePos, handleError, geoOptions);
        
        renderLog();
    }

    function updatePos(pos) {
        userCoords = pos.coords;
        const d = calcularDistancia(pos.coords.latitude, pos.coords.longitude, CONFIG.lat, CONFIG.lon);
        const status = document.getElementById('status');
        const btn = document.getElementById('btnReg');

        if (d <= CONFIG.rango) {
            status.innerHTML = `‚úÖ DENTRO DE ZONA (${Math.round(d)}m)`;
            status.style.color = "#128C7E";
            status.style.backgroundColor = "#e6fffa";
            btn.disabled = false;
        } else {
            status.innerHTML = `üìç FUERA DE RANGO (${Math.round(d)}m)`;
            status.style.color = "#d9534f";
            status.style.backgroundColor = "#fff5f5";
            btn.disabled = true;
        }
    }

    function handleError(err) {
        const status = document.getElementById('status');
        if (err.code === 1) status.innerHTML = "‚ùå Error: Permiso de ubicaci√≥n denegado";
        else if (err.code === 2) status.innerHTML = "‚ùå Error: Sin se√±al (Sal al exterior)";
        else if (err.code === 3) status.innerHTML = "‚ùå Error: Tiempo agotado";
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
        const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dp/2)**2 + Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function registrar() {
        const emp = document.getElementById('employee').value;
        if (!emp) return alert("Por favor selecciona tu nombre.");

        const ahora = new Date();
        const horaCorta = ahora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const fechaCorta = ahora.toLocaleDateString();
        
        // Registro en memoria local (Resiliencia)
        let registros = JSON.parse(localStorage.getItem('logs_secu')) || [];
        registros.unshift(`${fechaCorta} - ${horaCorta} (${emp})`);
        localStorage.setItem('logs_secu', JSON.stringify(registros.slice(0,5)));
        renderLog();

        // Construcci√≥n del mensaje de WhatsApp
        const mapa = `https://www.google.com/maps?q=${userCoords.latitude},${userCoords.longitude}`;
        const texto = encodeURIComponent(`üìç *REPORTE DE ASISTENCIA*\nüè¢ *Papeler√≠a La Secu*\nüë§ Empleado: ${emp}\nüïí Registro: ${horaCorta}\nüìÖ Fecha: ${fechaCorta}\nüó∫Ô∏è Ubicaci√≥n: ${mapa}\n\n‚úÖ Registro validado por GPS satelital.`);
        
        window.location.href = `https://wa.me/${CONFIG.tel}?text=${texto}`;
    }

    function renderLog() {
        const logs = JSON.parse(localStorage.getItem('logs_secu')) || [];
        document.getElementById('logBox').innerHTML = logs.map(l => `<div class="log-item">${l}</div>`).join('');
    }

    window.onload = init;
</script>

</body>
</html>